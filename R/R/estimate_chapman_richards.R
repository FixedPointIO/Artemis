library(nortest)
library(robustbase)
library(openxlsx)
library(ggplot2)

estimate_chapman_richards <- function(data, species_col = 'botanical_names', output_dir = getwd()) {
  
  # Create output directories
  current_datetime <- format(Sys.time(), '%Y%m%d_%H%M%S')
  output_folder_name <- paste0("artemis_", current_datetime)
  image_folder_path <- file.path(output_dir, output_folder_name, 'images')
  numerical_folder_path <- file.path(output_dir, output_folder_name, 'numerical')
  dir.create(image_folder_path, recursive = TRUE)
  dir.create(numerical_folder_path, recursive = TRUE)
  
  # Placeholder for results
  param_results <- data.frame(species = character(), A = numeric(), k = numeric(), p = numeric(), stringsAsFactors = FALSE)
  
  # For fitted values
  age_range <- 1:30
  fitted_values <- data.frame(age = age_range)
  
  # For each species, estimate parameters
  for (species in unique(data[[species_col]])) {
    species_data <- subset(data, data[[species_col]] == species)
    
    # Attempt to fit model, with a starting value for p of 3 and then 4
    tryCatch({
      model <- nlrob(height ~ A * (1 - exp(-k * age))^p, 
                    data = species_data, 
                    start = list(A = max(species_data$height), k = 0.03, p = 3), 
                    trace = FALSE)
    }, error = function(e) {
      model <- nlrob(height ~ A * (1 - exp(-k * age))^p, 
                    data = species_data, 
                    start = list(A = max(species_data$height), k = 0.03, p = 4), 
                    trace = FALSE)
    })
    
    # Save parameters
    param_results <- rbind(param_results, c(species, coef(model)))
    
    # Generate fitted values
    fitted_height <- coef(model)['A'] * (1 - exp(-coef(model)['k'] * age_range))^coef(model)['p']
    fitted_values[species] <- fitted_height
    
    # QQ plot for species
    png(filename = file.path(image_folder_path, paste0(species, "_qq_plot.png")))
    qqnorm(residuals(model))
    qqline(residuals(model))
    dev.off()
  }
  
  # Save results to Excel
  write.xlsx(param_results, file.path(numerical_folder_path, "parameters.xlsx"), row.names = FALSE)
  write.xlsx(fitted_values, file.path(numerical_folder_path, "output_file.xlsx"), row.names = FALSE)
  
  return(list(parameters = param_results, fitted_values = fitted_values))
}
